<div #canvasContainer class="w-full h-full dotted-grid relative overflow-hidden transition-colors duration-500"
    [class.bg-indigo-50]="sandboxMode()" (click)="onCanvasClick()">
    <ngx-graph class="chart-container" [view]="view" [links]="edges()" [nodes]="nodes()" [curve]="curve"
        [layoutSettings]="layoutSettings" [enableZoom]="true" [autoZoom]="true" [panOnZoom]="true" [autoCenter]="true">
        <ng-template #defsTemplate>
            <svg:marker id="arrow" viewBox="0 -5 10 10" refX="8" refY="0" markerWidth="4" markerHeight="4"
                orient="auto">
                <svg:path d="M0,-5L10,0L0,5" class="arrow-head" />
            </svg:marker>
        </ng-template>

        <ng-template #nodeTemplate let-node>
            <svg:g class="node cursor-pointer transition-all duration-300"
                [class.opacity-30]="highlightedPath().size > 0 && !highlightedPath().has(node.id)"
                (click)="onNodeClick(node); $event.stopPropagation()">

                <!-- Card Background -->
                <svg:rect width="200" height="90" rx="4" ry="4" fill="white"
                    [attr.stroke]="selectedNodeId() === node.id ? '#000' : (node.isDraft ? '#6366f1' : '#d1d5db')"
                    [attr.stroke-width]="selectedNodeId() === node.id ? 2 : (node.isDraft ? 2 : 1)"
                    [attr.stroke-dasharray]="node.isDraft ? '5,5' : 'none'" class="shadow-sm"></svg:rect>

                <!-- Header Background -->
                <svg:path d="M 0.5 4 a 3.5 3.5 0 0 1 3.5 -3.5 h 192 a 3.5 3.5 0 0 1 3.5 3.5 v 20 h -199 z"
                    [attr.fill]="getNodeColor(node)" opacity="0.4"></svg:path>

                <!-- Header Text (Label) -->
                <svg:text x="10" y="18" font-size="11" font-weight="bold" fill="#1f2937">
                    {{ node.label.length > 25 ? node.label.substring(0, 25) + '...' : node.label }}
                </svg:text>

                <!-- Body Text: Type -->
                <svg:text x="10" y="45" font-size="10" font-weight="600" fill="#6b7280" text-transform="uppercase">
                    {{node.type}}
                </svg:text>

                <!-- Body Text: Jurisdiction -->
                <svg:text x="10" y="60" font-size="11" fill="#374151">
                    {{node.jurisdiction || 'Unknown'}}
                </svg:text>

                <!-- Compliance Status Dot -->
                <svg:circle *ngIf="getComplianceStatusColor(node) !== 'transparent'" cx="185" cy="75" r="5"
                    [attr.fill]="getComplianceStatusColor(node)" stroke="white" stroke-width="1"></svg:circle>

                <!-- Bottom Color Stripe -->
                <svg:rect x="0.5" y="86" width="199" height="3" [attr.fill]="getNodeColor(node)" rx="0" ry="0">
                </svg:rect>
            </svg:g>
        </ng-template>

        <ng-template #linkTemplate let-link>
            <svg:g class="edge transition-opacity duration-300"
                [class.opacity-30]="highlightedPath().size > 0 && !highlightedPath().has(link.id)">
                <svg:path class="line" stroke="#94a3b8" stroke-width="2" marker-end="url(#arrow)"></svg:path>
                <svg:text class="edge-label" text-anchor="middle" fill="#475569" font-size="11" font-weight="bold">
                    <textPath [attr.href]="'#' + link.id" startOffset="50%">
                        {{link.label}}
                    </textPath>
                </svg:text>
            </svg:g>
        </ng-template>
    </ngx-graph>

    <!-- Chart Title Overlay -->
    <div
        class="absolute top-4 right-4 bg-white/90 backdrop-blur border border-gray-200 p-3 rounded shadow-lg pointer-events-none select-none z-10 flex flex-col items-end">
        <h2 class="text-xl font-bold text-gray-800 mb-1">Economic Based Ownership Chart</h2>
        <div class="flex items-center space-x-2 mb-2">
            <div class="w-4 h-4 rounded-sm bg-red-600"></div>
            <span class="font-bold text-gray-700">Enterprise</span>
            <span class="text-gray-500">Entities</span>
        </div>

        <!-- Legend Content -->
        <div class="text-[10px] text-gray-600 space-y-1 text-right mt-2 border-t border-gray-100 pt-2 w-full">
            <div *ngFor="let item of dynamicLegend()" class="flex items-center justify-end space-x-2">
                <span>{{item.label}}</span>
                <div class="w-3 h-3 border border-gray-400 rounded-sm" [style.background-color]="item.color"></div>
            </div>
            <div class="flex items-center justify-end space-x-2 pt-1 mt-1 border-t border-gray-100">
                <span>Ownership %</span>
                <div class="w-4 h-0.5 bg-gray-400"></div>
            </div>
        </div>
    </div>
</div>