<div #canvasContainer class="w-full h-full dotted-grid relative overflow-hidden transition-colors duration-500"
    [class.bg-indigo-50]="sandboxMode()" (click)="onCanvasClick()">

    <!-- Graph Component -->
    <!-- Restored [zoomLevel] binding to enable zoom buttons -->
    <ngx-graph class="chart-container" [view]="view" [links]="edges()" [nodes]="nodes()" [curve]="curve"
        [layoutSettings]="layoutSettings" [enableZoom]="false" [autoZoom]="autoZoom()" [panOnZoom]="true"
        [autoCenter]="true" [zoomLevel]="zoomLevel()">

        <ng-template #defsTemplate>
            <svg:marker id="arrow" viewBox="0 -5 10 10" refX="8" refY="0" markerWidth="4" markerHeight="4"
                orient="auto">
                <svg:path d="M0,-5L10,0L0,5" class="arrow-head" />
            </svg:marker>
        </ng-template>

        <ng-template #nodeTemplate let-node>
            <svg:g class="node cursor-pointer transition-all duration-300"
                [class.opacity-30]="highlightedPath().size > 0 && !highlightedPath().has(node.id)"
                (click)="onNodeClick(node); $event.stopPropagation()">

                <!-- Card Background -->
                <svg:rect width="200" height="90" rx="4" ry="4"
                    style="fill: var(--node-bg, white); stroke: var(--border-color, #d1d5db)"
                    [attr.stroke-width]="selectedNodeId() === node.id ? 2 : (node.isDraft ? 2 : 1)"
                    [attr.stroke-dasharray]="node.isDraft ? '5,5' : 'none'" class="shadow-sm"></svg:rect>


                <!-- Header Background -->
                <svg:path d="M 0.5 4 a 3.5 3.5 0 0 1 3.5 -3.5 h 192 a 3.5 3.5 0 0 1 3.5 3.5 v 20 h -199 z"
                    [attr.fill]="getNodeColor(node)" opacity="0.4"></svg:path>

                <!-- Header Text (Label) -->
                <svg:text x="10" y="18" font-size="11" font-weight="bold" style="fill: var(--text-primary, #1f2937)">
                    {{ node.label.length > 25 ? node.label.substring(0, 25) + '...' : node.label }}
                </svg:text>

                <!-- Data Overlays (Signals) -->
                <svg:g *ngIf="dataOverlay() === 'OWNERSHIP'">
                    <svg:text x="10" y="45" font-size="10" font-weight="600"
                        style="fill: var(--text-secondary, #6b7280)">OWNERSHIP</svg:text>
                    <svg:text x="10" y="62" font-size="12" font-weight="bold"
                        style="fill: var(--text-primary, #111827)">
                        Direct: {{node.ownershipPercentage}}% | Effective: {{node.effectiveOwnership?.toFixed(1)}}%
                    </svg:text>
                </svg:g>

                <svg:g *ngIf="dataOverlay() === 'TAX'">
                    <svg:text x="10" y="45" font-size="10" font-weight="600" style="fill: var(--accent-color, #059669)">
                        TAX & RESIDENCY</svg:text>

                    <!-- Pillar Two Badge -->
                    <svg:g *ngIf="node.pillarTwoStatus">
                        <svg:rect [attr.x]="node.taxResidency?.length ? 100 : 70" y="37" width="60" height="12" rx="2"
                            [attr.fill]="node.pillarTwoStatus === 'In-Scope' ? '#fee2e2' : '#dcfce7'"
                            [attr.stroke]="node.pillarTwoStatus === 'In-Scope' ? '#ef4444' : '#22c55e'"
                            stroke-width="0.5"></svg:rect>
                        <svg:text [attr.x]="node.taxResidency?.length ? 130 : 100" y="46" font-size="7"
                            font-weight="bold" [attr.fill]="node.pillarTwoStatus === 'In-Scope' ? '#b91c1c' : '#15803d'"
                            text-anchor="middle">
                            P2: {{node.pillarTwoStatus}}
                        </svg:text>
                    </svg:g>

                    <svg:text x="10" y="62" font-size="12" font-weight="bold"
                        style="fill: var(--text-primary, #111827)">
                        CIT: {{node.citRate}}% | {{node.taxResidency}}
                    </svg:text>
                    <svg:text x="180" y="62" font-size="9" style="fill: var(--text-secondary, #6b7280)"
                        text-anchor="end">{{node.localCurrency}}
                    </svg:text>
                </svg:g>

                <!-- Bottom Status Indicator -->
                <svg:circle cx="185" cy="12" r="4" [attr.fill]="getStatusColor(node)" stroke="white" stroke-width="1"
                    *ngIf="node.status"></svg:circle>
            </svg:g>
        </ng-template>

        <ng-template #linkTemplate let-link>
            <svg:g class="edge transition-opacity duration-300"
                [class.opacity-30]="highlightedPath().size > 0 && !highlightedPath().has(link.id)">
                <svg:path class="line" stroke="#94a3b8" stroke-width="2" marker-end="url(#arrow)"></svg:path>
                <svg:text class="edge-label" text-anchor="middle" fill="#475569" font-size="11" font-weight="bold">
                    <textPath [attr.href]="'#' + link.id" startOffset="50%">
                        {{link.label}}
                    </textPath>
                </svg:text>
            </svg:g>
        </ng-template>
    </ngx-graph>

    <!-- Chart Title Overlay -->
    <div
        class="absolute top-4 right-4 bg-white/90 backdrop-blur border border-gray-200 p-3 rounded shadow-lg pointer-events-none select-none z-10 flex flex-col items-end">
        <h2 class="text-xl font-bold text-gray-800 mb-1">Economic Based Ownership Chart v2</h2>
        <div class="flex items-center space-x-2 mb-2">
            <div class="w-4 h-4 rounded-sm bg-blue-600"></div>
            <span class="font-bold text-gray-700">Enterprise</span>
            <span class="text-gray-500">Entities</span>
        </div>

        <!-- Legend Content -->
        <!-- Fixed: Explicitly using background-color style binding -->
        <div class="text-[10px] text-gray-600 space-y-1 text-right mt-2 border-t border-gray-100 pt-2 w-full">
            <div *ngFor="let item of dynamicLegend()" class="flex items-center justify-end space-x-2">
                <span>{{item.label}}</span>
                <div class="w-3 h-3 border border-gray-200 rounded-sm" [style.background-color]="item.color"></div>
            </div>
            <div class="flex items-center justify-end space-x-2 pt-1 mt-1 border-t border-gray-100">
                <span>Ownership %</span>
                <div class="w-4 h-0.5 bg-gray-400"></div>
            </div>
        </div>
    </div>

    <!-- Zoom Controls -->
    <!-- Added fixed dimensions and z-index to ensure visibility -->
    <div class="absolute bottom-6 right-6 flex flex-col space-y-2 z-50 pointer-events-auto">
        <button (click)="zoomIn()"
            class="w-10 h-10 bg-white border border-slate-200 rounded-lg shadow-lg flex items-center justify-center text-slate-600 hover:text-indigo-600 hover:border-indigo-200 hover:bg-slate-50 transition-all cursor-pointer">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
        </button>
        <button (click)="resetZoom()"
            class="w-10 h-10 bg-white border border-slate-200 rounded-lg shadow-lg flex items-center justify-center text-slate-600 hover:text-indigo-600 hover:border-indigo-200 hover:bg-slate-50 transition-all cursor-pointer">
            <span class="text-[10px] font-bold">{{(zoomLevel() * 100).toFixed(0)}}%</span>
        </button>
        <button (click)="zoomOut()"
            class="w-10 h-10 bg-white border border-slate-200 rounded-lg shadow-lg flex items-center justify-center text-slate-600 hover:text-indigo-600 hover:border-indigo-200 hover:bg-slate-50 transition-all cursor-pointer">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
            </svg>
        </button>
    </div>
</div>